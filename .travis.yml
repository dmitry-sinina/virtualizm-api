language: ruby
services:
- docker
git:
  depth: false
install: skip
stages:
- test
- stable package
- nightly package
script:
- 'docker-compose run app-deb10 make test

  '
jobs:
  include:
  - stage: test
    name: Run rake tests
    script:
    - docker-compose run app-deb10 make test
  - stage: test
    name: Rubocop and Bundle Audit
    script:
    - docker-compose run app-deb10 make lint
  - stage: stable package
    if: branch != master OR tag =~ ^.*$
    name: Stable Debian 10(buster) package
    script: &1
    - 'docker-compose run --name virtualizm-build-deb10 app-deb10 make package &&
      docker commit virtualizm-build-deb10 virtualizm:build-deb10

      '
    deploy:
      skip_cleanup: true
      provider: script
      script: docker run --name virtualizm-deploy-deb10 virtualizm:build-deb10 ci/deploy.sh
        "$API_ENDPOINT" buster "${TRAVIS_TAG%.*}" main /build/*.deb
      on:
        tags: true
        condition: "$TRAVIS_TAG != *-master*"
        repo: virtualizm/virtualizm-api
  - stage: nightly package
    if: branch = master
    name: Nightly Debian 10(buster) package
    script: *1
    deploy:
      skip_cleanup: true
      provider: script
      script: docker run --name virtualizm-deploy-deb10 virtualizm:build-deb10 ci/deploy.sh
        "$API_ENDPOINT" buster nightly main /build/*.deb
      on:
        all_branches: true
        repo: virtualizm/virtualizm-api
env:
  global:
    secure: t0F4RTHNDwZPaRuPOal7mI/cg7X7N5R2h7/+HiOL/gtEoxOXahuj0Y9lCVf6AZiQxTv0r0F+DMLG9Rc6awkavPV3o6i5LeP883HDSMfvHGdw/+PcIBv4RyVXbOPG7aEnE9gvG8CjIeUVKRbHLQ1J89s8bBLCPpDnmYrZ2p9fm1WdMToDZIlAOixW/1+JJIZjEaa9KC6hmpYB/MRznhn97RRy0Sfvln5XRrBwN5zNR2+5HlzFNEm9fmAP8ECYmHCAXMRutvpbKGCeH++RMnTR7M1qp8YMwwvILtj5PMfQIQM/R8Ivj6Po3UMllENLP31cs9/QP2itTIhHfVcPneDG582Qrv2TqxXb+XCtM9bk3i1uCu72wsBLQUBFpueLvBvwwuenpkTafv1Od5svfO7Kh7L+3Mh4cYjLknYlYu91T1DiVb900D2m6P4roRzcc+5nHDKw7IezF8s+exkZXFNe34n1O38QHvLI7CFojhVFSx12RObvZSDpn2CG8UN4fNkWw6OXD+XEoVKW/NQpsaW7rmOGVgEsRLB2XzwUDE8E+qw6h62xUVqCRcVwxxdNt/ANDZKdiXR0CWXjQyry6zfzO8to4E28N360aIZB9My0GDZITSfRyC18ANAAMUUo1ItEVTa3pSTBrweP/YK6DEOZAOlNN9atHpknevwQzA0vitU=
