language: ruby
services:
- docker
git:
  depth: false
install: skip
stages:
- test
- stable package
- nightly package
script:
- 'docker-compose run app-deb10 make test

  '
jobs:
  include:
  - stage: test
    name: Run rake tests
    script:
    - docker-compose run app-deb10 make test
  - stage: test
    name: Rubocop and Bundle Audit
    script:
    - docker-compose run app-deb10 make lint
  - stage: stable package
    if: branch != master OR tag =~ ^.*$
    name: Stable Debian 10(buster) package
    script: &1
    - 'docker-compose run --name virtualizm-build-deb10 app-deb10 make package &&
      docker commit virtualizm-build-deb10 virtualizm:build-deb10

      '
    deploy:
      skip_cleanup: true
      provider: script
      script: docker run --name virtualizm-deploy-deb10 virtualizm:build-deb10 ci/deploy.sh
        "$API_ENDPOINT" buster "${TRAVIS_TAG%.*}" main /build/*.deb
      on:
        tags: true
        condition: "$TRAVIS_TAG != *-master*"
        repo: virtualizm/virtualizm-api
  - stage: nightly package
    if: branch = master
    name: Nightly Debian 10(buster) package
    script: *1
    deploy:
      skip_cleanup: true
      provider: script
      script: docker run --name virtualizm-deploy-deb10 virtualizm:build-deb10 ci/deploy.sh
        "$API_ENDPOINT" buster nightly main /build/*.deb
      on:
        all_branches: true
        repo: virtualizm/virtualizm-api
env:
  global:
    secure: U3U2b/iIVS1/LkXFzT+g5IwXWLw2dqmYLQqT8ixP8tpW5zTzE31T1cTBBsp+S52w5LqPONC96bFGNQYswlKpMkhNiHgslQLP+TZFty/Er5PXsk0E8jGQEcRDSegE2BA8EoL8riGofBBVue8sGHDugHd2a578ixa6a/8hxEx4Fnkgm4f5h3PdqlThfp9wLOWEsxy+yxWWgflOOdbktMxE7sFg40YzbttqhwFf4s74ahRoUBWdvmWE0MLSm3C3srMDhURQssvITrAuXbW429jtL4Wl3N+GV9dYszwBwJzHpxszoDWLyiasHOD3fe7SoO+F+dhKndLZVklNqho8qjQWGHSm0ugr2VAjqn6hV54UiB/2L+jNva93fvw4GxtD/fUlIRDpHYD/Te61FA8RTwvj5OmIn7t4Q2a++Zt4j1u/kNrRww8A1zCwvG8NSnBqs3DB/g7vdBm29gRCg4vCCaI9hWUxq0Kqz9hOLnqDxJapLLDWEuZC1TabHRZPD+xZW/eTGcqTiWMeXg1R9l/J5+uacG77GCH+eO7dUT7oQquYLb9gvZqDuUFB+6G05ppYWHzi1hJ0BJT7ldjD/8hX+OGGRM7MCZ6WBCSgED8gDM57SLJHcEuBH2gvWDHIZK6eDKAIWhlYzOaSPmjksgarEG0gHlIBjKKmb4ihtXNT2dLlKV0=
